#!/bin/sh

# ユーティリティ タイトル表示
title() {
    echo "-----> $*"
}

# ユーティリティ サブタイトル表示
subtitle() {
    echo "       $*"
}

#echo "-------------------- current"
#pwd
#ls -la
#echo "-------------------- /"
#cd /
#pwd
#ls -la
echo "-------------------- $HOME"
cd $HOME
pwd
ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/'
#echo "--------------------　BUILD_DIR"
#cd $BUILD_DIR
#pwd
#ls -la
#echo "--------------------"
#exit 0
#tree
#exit 0


title "initlialize"
BUILD_DIR=$1 # /tmp/build_#HASH#
#INSTALL_DIR=$BUILD_DIR/.heroku
INSTALL_DIR=$HOME/.heroku
mkdir -p $INSTALL_DIR
CACHE_DIR=$2 #/app/tmp/cache

# mecabのインストール
title "build mecab"
subtitle "get tarball"
curl -s -L http://nethive.info/lib_dev/mecab-0.996.tar.gz > $CACHE_DIR/mecab-0.996.tar.gz
subtitle "unzip"
cd $CACHE_DIR/
tar zxf mecab-0.996.tar.gz
subtitle "configure"
cd ./mecab-0.996
#./configure
./configure --silent --prefix=$INSTALL_DIR/mecab-0.996 --sysconfdir=$INSTALL_DIR/mecab-0.996/etc
subtitle "make"
make --silent
subtitle "install"
#make install
#cp -pr 頑張る → /app
subtitle "done"

subtitle "----------------"
cd $INSTALL_DIR
ls -la
subtitle "----------------"
exit 0

# ipadicのインストール
title "build ipadic"
subtitle "get tarball"
curl -s -L http://nethive.info/lib_dev/mecab-ipadic-2.7.0-20070801.tar.gz > $CACHE_DIR/mecab-ipadic-2.7.0-20070801.tar.gz
subtitle "unzip"
cd $CACHE_DIR/ 
tar zxf mecab-ipadic-2.7.0-20070801.tar.gz
subtitle "configure"
cd ./mecab-ipadic-2.7.0-20070801
#./configure 
./configure --silent --prefix=$INSTALL_DIR/mecab-ipadic-2.7.0-20070801 --with-charset=utf8 --with-dicdir=$INSTALL_DIR/mecab-ipadic-2.7.0-20070801/lib/mecab/dic/ipadic --with-mecab-config=$INSTALL_DIR/mecab-0.996/bin/mecab-config
subtitle "make"
make --silent
subtitle "install"
make install
subtitle "done"

title "tune mecab dictionary path"
cd $INSTALL_DIR/mecab-0.996/etc/
# 区切り文字を/にすると$変数内の/が解決できなくなるため|を利用
sed -e "s|^dicdir.*|dicdir = $INSTALL_DIR/mecab-ipadic-2.7.0-20070801/lib/mecab/dic/ipadic|" mecabrc

subtitle "------------"
cd /app/.heroku/mecab-0.996/bin/
pwd
ls -la
subtitle "------------"
#ls -la /app/lib/mecab-ipadic-2.7.0-20070801

title "set env path"
PROFILE_DIR=".profile.d"
mkdir -p $BUILD_DIR/$PROFILE_DIR
echo 'export PATH="$PATH:$HOME/.heroku/mecab-0.996/bin"'>> $BUILD_DIR/$PROFILE_DIR/mecab.sh
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$HOME/.heroku/mecab-0.996/lib"'>> $BUILD_DIR/$PROFILE_DIR/mecab.sh
