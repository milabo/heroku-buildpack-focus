#!/bin/sh

# ユーティリティ タイトル表示
title() {
    echo "-----> $*"
}

# ユーティリティ サブタイトル表示
subtitle() {
    echo "       $*"
}

BUILD_DIR=$1
APP_DIR="app"
LIB_DIR="lib"

CACHE_DIR=$2
VENDOR_DIR="vendor/lib"

title "initlialize"
subtitle "make VENDOR_DIR"
mkdir -p $CACHE_DIR
cd $CACHE_DIR
mkdir -p $VENDOR_DIR
subtitle "make APP_DIR"
mkdir -p $BUILD_DIR
cd $BUILD_DIR
mkdir -p $APP_DIR
subtitle "get tarball"
curl -s -L http://nethive.info/lib_dev/mecab-0.996.tar.gz > $CACHE_DIR/$VENDOR_DIR/mecab-0.996.tar.gz
curl -s -L http://nethive.info/lib_dev/mecab-ipadic-2.7.0-20070801.tar.gz > $CACHE_DIR/$VENDOR_DIR/mecab-ipadic-2.7.0-20070801.tar.gz

title "build mecab"
subtitle "unzip"
tar zxf $CACHE_DIR/$VENDOR_DIR/mecab-0.996.tar.gz
subtitle "configure"
cd ./mecab-0.996
./configure --prefix=$BUILD_DIR/$LIB_DIR/mecab-0.996 --sysconfdir=$BUILD_DIR/$LIB_DIR/mecab-0.996/etc
subtitle "make"
make -s
subtitle "install"
make install
cd $HOME
subtitle "done"

title "build ipadic"
subtitle "unzip"
cd 
tar zxf $CACHE_DIR/$VENDOR_DIR/mecab-ipadic-2.7.0-20070801.tar.gz
subtitle "configure"
cd ./mecab-ipadic-2.7.0-20070801
./configure --prefix=$BUILD_DIR/$LIB_DIR/mecab-ipadic-2.7.0-20070801 --with-charset=utf8 --with-dicdir=$BUILD_DIR/$LIB_DIR/mecab-ipadic-2.7.0-20070801/lib/mecab/dic/ipadic --with-mecab-config=$BUILD_DIR/$LIB_DIR/mecab-0.996/bin/mecab-config
subtitle "make"
make -s
subtitle "install"
make install
cd $HOME
subtitle "done"

title "tune mecab dictionary path"
cd $BUILD_DIR/$LIB_DIR/mecab-0.996/etc/
subtitle "replace dicdir"
# 区切り文字を/にすると$変数内の/が解決できなくなるため|を利用
sed -e "s|^dicdir.*|dicdir = $BUILD_DIR/$LIB_DIR/mecab-ipadic-2.7.0-20070801/lib/mecab/dic/ipadic|" mecabrc
cd $HOME

title "set env path"
cd $BUILD_DIR
PROFILE_DIR=".profile.d"
mkdir -p $PROFILE_DIR
#PROFILE_PATH = $BUILD_DIR/$PROFILE_DIR/mecab.sh
#mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:$BUILD_DIR/$APP_DIR/mecab-0.996/bin"'>> $BUILD_DIR/$PROFILE_DIR/$PROFILE_PATH/mecab.sh
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$BUILD_DIR/$APP_DIR/mecab-0.996/lib"'>> $BUILD_DIR/$PROFILE_DIR/$PROFILE_PATH/mecab.sh
