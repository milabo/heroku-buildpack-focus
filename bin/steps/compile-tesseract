#!/usr/bin/env bash

# Syntax sugar
tesseract_indent () {
    echo "       [tesseract] $*"
}

# Initialize
tesseract_indent "initlialize"
BUILD_DIR=$1   # /tmp/build_#HASH#
LIB_DIR=$2     # $BIN_DIR/lib
INSTALL_DIR=$3 # /app/.vendor
CACHE_DIR=$4   # /app/tmp/cache
PROFILE_DIR=$5 # $BUILD_DIR/.profile.d

# Build leptonica
tesseract_indent "build leptonica"
#curl -s -L http://www.leptonica.com/source/leptonica-1.71.tar.gz | tar zx -C $CACHE_DIR
#cd $CACHE_DIR/leptonica-1.71
#./configure --silent --prefix=$INSTALL_DIR/leptonica-1.71
#make --silent | indent
#make --silent install | indent
tar -zxf $LIB_DIR/leptonica-1.71.tar.gz -C $CACHE_DIR
cd $CACHE_DIR/leptonica-1.71
make install --silent | indent

# Build tesseract
tesseract_indent "build tesseract"
curl -s -L http://nethive.info/lib_dev/tesseract.tar.gz | tar zx -C $CACHE_DIR
cd $CACHE_DIR/tesseract
make install --silent | indent


# Build langdata
tesseract_indent "build langdata"
git clone git://github.com/tesseract-ocr/langdata.git $INSTALL_DIR/tesseract/work
cd $INSTALL_DIR/tesseract/work/
ls -F | egrep -v "jpn|eng" | grep "/$" | xargs rm -rf # Delete langdata other than "jpn" & "eng"
rm -rf $INSTALL_DIR/tesseract/work/.git # Delete .git files
rm -rf $INSTALL_DIR/tesseract/lib/libtesseract.a

# Set .profile.d script
tesseract_indent "set env path"
echo 'export PATH="$PATH:/app/.vendor/tesseract/bin"' >> $PROFILE_DIR/tesseract.sh
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/app/.vendor/tesseract/lib"' >> $PROFILE_DIR/tesseract.sh
echo 'export TESSDATA_PREFIX=/app/.vendor/tesseract/work' >> $PROFILE_DIR/tesseract.sh
