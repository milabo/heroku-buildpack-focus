#!/usr/bin/env bash

# Syntax sugar
opencv_indent () {
    echo "       [opencv] $*"
}

# Initialize
mecab_indent "initlialize"
BUILD_DIR=$1   # /tmp/build_#HASH#
LIB_DIR=$2     # $BIN_DIR/lib
INSTALL_DIR=$3 # /app/.vendor
CACHE_DIR=$4   # /app/tmp/cache
PROFILE_DIR=$5 # $BUILD_DIR/.profile.d

rm -rf $CACHE_DIR/cmake-3.6.2
rm -rf $CACHE_DIR/opencv
rm -rf $CACHE_DIR/Miniconda-latest-Linux-x86_64.sh

# Build cmake
#opencv_indent "build cmake"
#curl -s -L https://cmake.org/files/v3.6/cmake-3.6.2.tar.gz | tar zx -C $CACHE_DIR
#cd $CACHE_DIR/cmake-3.6.2/
#./bootstrap --prefix=/app/.vendor/cmake-3.6.2/
#make
#make install

# Build openCV
#opencv_indent "build opencv"
#git clone --depth=1 -b 3.1.0 https://github.com/opencv/opencv $CACHE_DIR/opencv
#cd $CACHE_DIR/opencv
#/app/.vendor/cmake-3.6.2/bin/cmake -D CMAKE_BUILD_TYPE=release CMAKE_PREFIX=/app/.vendor/opencv
#cd release
#make --silent | indent
#make install --silent | indent

# Build miniconda
cd $CACHE_DIR
curl -Os https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -p /app/.heroku/miniconda/ -b | indent
cd /app/.heroku/miniconda/bin
./conda install pip --yes | indent
./conda install -c https://conda.anaconda.org/menpo opencv3 --yes

if [ -f $BUILD_DIR/requirements.txt ]; then
    echo "Installing dependencies using Pip" | indent
    pip install -r $BUILD_DIR/requirements.txt  --exists-action=w --allow-all-external | indent
fi

./conda clean -pt --yes > /dev/null

# Set .profile.d script
# Please do not use locally $variables in buildpack when you set environment variables, 
# because .profile.d script runs after slug built, and this can not detect $variables.
mecab_indent "set env path"
#echo 'export PATH="$PATH:/app/.vendor/opencv/bin"' >> $PROFILE_DIR/opencv.sh
#echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/app/.vendor/opencv/lib"' >> $PROFILE_DIR/opencv.sh
echo 'export PATH="$PATH:/app/.heroku/miniconda/bin"' >> $PROFILE_DIR/conda.sh
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/app/.heroku/miniconda/lib"' >> $PROFILE_DIR/conda.sh
