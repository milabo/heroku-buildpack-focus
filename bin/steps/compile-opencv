#!/usr/bin/env bash

# Syntax sugar
opencv_indent () {
    echo "       [opencv] $*"
}

# Initialize
opencv_indent "initlialize"
BUILD_DIR=$1   # /tmp/build_#HASH#
LIB_DIR=$2     # $BIN_DIR/lib
INSTALL_DIR=$3 # /app/.vendor
CACHE_DIR=$4   # /app/tmp/cache
PROFILE_DIR=$5 # $BUILD_DIR/.profile.d

rm -rf $CACHE_DIR/cmake-3.6.2
rm -rf $CACHE_DIR/opencv
rm -rf $CACHE_DIR/Miniconda3-latest-Linux-x86_64.sh
rm -rf /app/.vendor
#ls /app/.heroku/miniconda


# Build cmake
#opencv_indent "build cmake"
curl -s -L https://cmake.org/files/v3.6/cmake-3.6.2.tar.gz | tar zx -C $CACHE_DIR
cd $CACHE_DIR/cmake-3.6.2/
./bootstrap --prefix=$CACHE_DIR/cmake/
make
make install

# Build openCV
opencv_indent "build opencv"
#git clone --depth=1 -b 3.1.0 https://github.com/opencv/opencv $CACHE_DIR/opencv
#cd $CACHE_DIR/opencv
#/app/.vendor/cmake-3.6.2/bin/cmake -D CMAKE_BUILD_TYPE=release CMAKE_PREFIX=/app/.vendor/opencv
#cd release
#make --silent | indent
#make install --silent | indent
cp -pr $LIB_DIR/opencv-3.1.0 $CACHE_DIR
cd $CACHE_DIR/opencv-3.1.0/build
make install --silent | indent

# Build miniconda
#opencv_indent "build opencv with miniconda"
#mkdir -p /app/.vendor/miniconda
#cd $CACHE_DIR
#curl -Os https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
#bash Miniconda3-latest-Linux-x86_64.sh -p /app/.vendor/miniconda/ -b | indent
#cd /app/.vendor/miniconda/bin
#./conda install pip --yes | indent
#./conda install -c https://conda.anaconda.org/menpo opencv3 --yes

#opencv_indent "build app's requirements with pip in miniconda"
#cd $BUILD_DIR
#if [ -f requirements.txt ]; then
#    echo "Installing dependencies using Pip" | indent
#    /app/.vendor/miniconda/bin/pip install -r requirements.txt  --exists-action=w --allow-all-external | indent
#fi

#opencv_indent "clean miniconda"
#cd /app/.vendor/miniconda/bin
#./conda clean -pt --yes > /dev/null

# Set .profile.d script
# Please do not use locally $variables in buildpack when you set environment variables, 
# because .profile.d script runs after slug built, and this can not detect $variables.
opencv_indent "set env path"
echo 'export PATH="$PATH:/app/.vendor/opencv-3.1.0/bin"' >> $PROFILE_DIR/opencv.sh
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/app/.vendor/opencv-3.1.0/lib"' >> $PROFILE_DIR/opencv.sh
#echo 'export PATH="$PATH:/app/.vendor/miniconda/bin"' >> $PROFILE_DIR/conda.sh
#echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/app/.vendor/miniconda/lib"' >> $PROFILE_DIR/conda.sh
