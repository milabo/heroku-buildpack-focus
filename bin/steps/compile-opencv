#!/usr/bin/env bash

# Syntax sugar
opencv_indent () {
    echo "       [opencv] $*"
}

# Initialize
opencv_indent "initlialize"
BUILD_DIR=$1   # /tmp/build_#HASH#
LIB_DIR=$2     # $BIN_DIR/lib
INSTALL_DIR=$3 # /app/.vendor
CACHE_DIR=$4   # /app/tmp/cache
PROFILE_DIR=$5 # $BUILD_DIR/.profile.d

rm -rf $CACHE_DIR/cmake-3.6.2
rm -rf $CACHE_DIR/opencv
rm -rf $CACHE_DIR/Miniconda3-latest-Linux-x86_64.sh
rm -rf $CACHE_DIR/opencv-3.1.0.zip
rm -rf $CACHE_DIR/opencv-3.1.0.tar.gz
rm -rf $CACHE_DIR/opencv-3.1.0
#ls /app/.heroku/miniconda


# Build cmake
#opencv_indent "build cmake"
#curl -s -L https://cmake.org/files/v3.6/cmake-3.6.2.tar.gz | tar zx -C $CACHE_DIR
#cd $CACHE_DIR/cmake-3.6.2/
#./bootstrap --prefix=$CACHE_DIR/cmake/
#make
#make install
#export PATH=$PATH:$CACHE_DIR/cmake/bin/

# Build openCV
opencv_indent "build opencv"
#cd $CACHE_DIR/
#wget http://downloads.sourceforge.net/project/opencvlibrary/opencv-unix/3.1.0/opencv-3.1.0.zip
#unzip -o opencv-3.1.0.zip
#cd opencv-3.1.0
#mkdir -p build
#cd build
#cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=$INSTALL_DIR/opencv-3.1.0 -D BUILD_opencv_java=OFF -D WITH_IPP=OFF -D WITH_1394=OFF -D WITH_FFMPEG=OFF -D BUILD_EXAMPLES=OFF -D BUILD_TESTS=OFF -D BUILD_PERF_TESTS=OFF -D BUILD_DOCS=OFF -D BUILD_opencv_python2=ON -D BUILD_opencv_python3=ON -D BUILD_opencv_video=OFF -D BUILD_opencv_videoio=OFF -D BUILD_opencv_videostab=OFF -D PYTHON_EXECUTABLE=$(which python) ..
#make --silent
#make install --silent | indent
tar zx $LIB_DIR/opencv-3.1.0.tar.gz -C $CACHE_DIR/
cd $CACHE_DIR/
cp opencv-3.1.0 $INSTALL_DIR/

# Set .profile.d script
# Please do not use locally $variables in buildpack when you set environment variables, 
# because .profile.d script runs after slug built, and this can not detect $variables.
opencv_indent "set env path"
echo 'export PATH="$PATH:/app/.vendor/opencv-3.1.0/bin"' >> $PROFILE_DIR/opencv.sh
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/app/.vendor/opencv-3.1.0/lib"' >> $PROFILE_DIR/opencv.sh
