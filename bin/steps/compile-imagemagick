#!/usr/bin/env bash

# Syntax sugar
imagemagick_indent () {
    echo "       [imagemagick] $*"
}

# Initialize
imagemagick_indent "initlialize"
BUILD_DIR=$1   # /tmp/build_#HASH#
LIB_DIR=$2     # $BIN_DIR/lib
INSTALL_DIR=$3 # /app/.vendor
CACHE_DIR=$4   # /app/tmp/cache
PROFILE_DIR=$5 # $BUILD_DIR/.profile.d

# Build imagemagick
imagemagick_indent "build imagemagick"
curl -s -L http://www.imagemagick.org/download/releases/ImageMagick-7.0.1-10.tar.xz | tar Jx -C $CACHE_DIR
cd $CACHE_DIR/ImageMagick-7.0.1-10
./configure --silent --prefix=$INSTALL_DIR/ImageMagick-7.0.1-10
make --silent | indent
make --silent install | indent

# Write policy file
imagemagick_indent "write policy file"
mkdir -p $INSTALL_DIR/ImageMagick-7.0.1-10/etc/ImageMagick
cat > $INSTALL_DIR/policy.xml <<EOF
<policymap>
  <policy domain="coder" rights="none" pattern="EPHEMERAL" />
  <policy domain="coder" rights="none" pattern="HTTPS" />
  <policy domain="coder" rights="none" pattern="MVG" />
  <policy domain="coder" rights="none" pattern="MSL" />
</policymap>
EOF

# Set .profile.d script
# Please do not use locally $variables in buildpack when you set environment variables, 
# because .profile.d script runs after slug built, and this can not detect $variables.
imagemagick_indent "set env path"
echo 'export PATH="$PATH:/app/.vendor/ImageMagick-7.0.1-10/bin"' >> $PROFILE_DIR/imagemagick.sh
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/app/.vendor/ImageMagick-7.0.1-10/lib"' >> $PROFILE_DIR/imagemagick.sh
echo 'export MAGICK_CONFIGURE_PATH=/app/.vendor/ImageMagick-7.0.1-10' >> $PROFILE_DIR/imagemagick.sh